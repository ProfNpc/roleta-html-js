<!DOCTYPE html>
<html>
	<head>
		<title>Sorteador</title>
	</head>
	
	<script>
		

	
		function borda(circuloBorda) {
			const startAngle = 0;
			const endAngle = 2 * Math.PI; //volta completa
			const canvas = document.getElementById("myCanvas");
			const ctx = canvas.getContext("2d");
			ctx.beginPath();
			ctx.arc(circuloBorda.x, circuloBorda.y, circuloBorda.raio, 0, 2 * Math.PI);
			ctx.stroke();
		}
		
		function rotate(cx, cy, x, y, angle) {
			var radians = (Math.PI / 180) * angle,
				cos = Math.cos(radians),
				sin = Math.sin(radians),
				nx = (cos * (x - cx)) + (sin * (y - cy)) + cx,
				ny = (cos * (y - cy)) - (sin * (x - cx)) + cy;
			return [nx, ny];
		}
		
		function numeroFatia(circuloBorda, angulo, numero) {
			const canvas = document.getElementById("myCanvas");
			const ctx = canvas.getContext("2d");		
			ctx.beginPath();
			ctx.font = circuloBorda.raio * 0.15 + "px arial";
			ctx.textBaseline="middle";
			ctx.textAlign="center";
			
			var length = circuloBorda.raio - 15;
			
			var x = circuloBorda.x;
			var y = circuloBorda.y + length;
			
			var coordenadasRotacionadas = rotate(circuloBorda.x, circuloBorda.y, x, y, angulo);
			
			ctx.fillText(numero + "", coordenadasRotacionadas[0], coordenadasRotacionadas[1]);
		}
		
		function raioCirculo(circuloBorda, angulo) {
			//console.log('angulo=' + angulo);
			const canvas = document.getElementById("myCanvas");
			const ctx = canvas.getContext("2d");		
			ctx.beginPath();
			
			var length = circuloBorda.raio;
			
			ctx.moveTo(circuloBorda.x, circuloBorda.y);
			//ctx.lineTo(circuloBorda.x + length * Math.cos(angulo), circuloBorda.y + length * Math.sin(angulo));
			
			var x = circuloBorda.x;
			var y = circuloBorda.y + length;
			
			var coordenadasRotacionadas = rotate(circuloBorda.x, circuloBorda.y, x, y, angulo);
			
			ctx.lineTo(coordenadasRotacionadas[0], coordenadasRotacionadas[1]);
			
			//ctx.lineTo(circuloBorda.x - length * Math.cos(angulo), circuloBorda.y + length * Math.sin(angulo));
			
			ctx.stroke();
		}
		
		function roleta(circuloBorda, numFatias, anguloBase) {
			borda(circuloBorda);
			
			var anguloFatiaPizza = 360.0 / numFatias;
			
			console.log('anguloFatiaPizza=' + anguloFatiaPizza);
			
			var angulo = 0;
			

			/*
			raioCirculo(circuloBorda, 120);
			
			raioCirculo(circuloBorda, 240);
			
			raioCirculo(circuloBorda, 0);
			*/
			
			
			var fatiaSelecionada = parseInt(anguloBase / anguloFatiaPizza);
			
			desenharFatiaSelecionada(circuloBorda, -anguloBase, anguloFatiaPizza, numFatias - fatiaSelecionada);
			
			desenharMarcador(circuloBorda);
			
			for (var fatia = 0; fatia < numFatias; fatia++) {


			
			
				raioCirculo(circuloBorda, (anguloBase + 90) + angulo);
				
				numeroFatia(circuloBorda, (anguloBase + 90) + angulo + (anguloFatiaPizza/2), array[fatia]);
				
				angulo += anguloFatiaPizza;				
				
			}
		
		}
		
		function desenharMarcador(circuloBorda) {
			const canvas = document.getElementById("myCanvas");
			const ctx = canvas.getContext("2d");		
			ctx.beginPath();
			
			var length = circuloBorda.raio * 0.1;
			
			ctx.moveTo(circuloBorda.x + (circuloBorda.raio - length), circuloBorda.y );
			
			ctx.lineTo(circuloBorda.x + (circuloBorda.raio + length), circuloBorda.y );

			var lineWidth = ctx.lineWidth;
			var strokeStyle = ctx.strokeStyle;

			ctx.lineWidth = 4;
			ctx.strokeStyle = "blue";
			ctx.stroke();
			
			ctx.lineWidth = lineWidth;
			ctx.strokeStyle = strokeStyle;
		}

		function getRadianos(graus) {
			return (graus * Math.PI) / 180;
		}

		function desenharFatiaSelecionada(
			circuloBorda, 
			anguloBase, 
			anguloFatiaPizza, 
			fatiaSelecionada) {//0 .. numFatias - 1
			
			
			desenharFatia(circuloBorda, anguloBase + (-fatiaSelecionada * anguloFatiaPizza), anguloFatiaPizza);
			
		}

		function desenharFatia(
			circuloBorda, 
			anguloBase, 
			anguloFatiaPizza) { 
			
			const canvas = document.getElementById("myCanvas");
			const ctx = canvas.getContext("2d");

			ctx.beginPath();
			console.log('anguloBase=' + anguloBase);
			
			ctx.moveTo(circuloBorda.x, circuloBorda.y);
			
			//anguloBase += 24;
			
			var x = circuloBorda.x;
			var y = circuloBorda.y + length;
			
			var coordenadasRotacionadas = rotate(circuloBorda.x, circuloBorda.y, x, y, anguloBase);
			
			ctx.lineTo(coordenadasRotacionadas[0], coordenadasRotacionadas[1]);			

			ctx.arc(
				circuloBorda.x, 
				circuloBorda.y, 
				circuloBorda.raio, 
				getRadianos(anguloBase), 
				getRadianos(anguloBase + anguloFatiaPizza));
			
			coordenadasRotacionadas = rotate(circuloBorda.x, circuloBorda.y, x, y, anguloBase + anguloFatiaPizza);
			
			ctx.lineTo(coordenadasRotacionadas[0], coordenadasRotacionadas[1]);	
			
			ctx.fill();
			
			var fillStyle = ctx.fillStyle;
			
			ctx.fillStyle = "yellow";//"red";
			ctx.fill();
			//ctx.lineWidth = 4;
			//ctx.strokeStyle = "blue";
			ctx.stroke();
			
			ctx.fillStyle = fillStyle;
		}
		
		function shuffle(array) {
			let currentIndex = array.length;

			// While there remain elements to shuffle...
			while (currentIndex != 0) {

				// Pick a remaining element...
				let randomIndex = Math.floor(Math.random() * currentIndex);
				currentIndex--;

				// And swap it with the current element.
				[array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
			}
		}
		
		function disporNumerosNaRoleta(array) {
			let currentIndex = array.length;
			
			if  (currentIndex != 0) {

				// Pick a remaining element...
				let randomIndex = Math.floor(Math.random() * currentIndex);
				
				var part1 = array.slice(0, randomIndex);
				var part2 = array.slice(randomIndex);
				
				var pos = 0;
				for (var i = 0; i < part2.length; i++, pos++) {
					array[pos] = part2[i];
				}
				for (var i = 0; i < part1.length; i++, pos++) {
					array[pos] = part1[i];
				}
			}			
		}

		var numeroPalavras = 8;
		var velocidade = 1000;
		var meiaFatiaDeVelocidade = (360/numeroPalavras)/2;
		var voltas = 0;
		
		var anguloBase = 0;//(360/numeroPalavras)/2;
		var anguloBaseInicial = null;		
		
		var array = [];

		function desenharRoleta() {
			var circuloBorda = {
				x: 250.0,
				y: 250.0,
				raio: 200.0
			};
			
			const canvas = document.getElementById("myCanvas");
			const ctx = canvas.getContext('2d');
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			roleta(circuloBorda, numeroPalavras, anguloBase);
			
			console.log('velocidade=' + velocidade);
			
			var txtAnguloBase = document.getElementById("txtAnguloBase");
			txtAnguloBase.value = anguloBase;
			
		}
		
		function desenharRoletaOld() {
			var circuloBorda = {
				x: 250.0,
				y: 250.0,
				raio: 200.0
			};
			
			const canvas = document.getElementById("myCanvas");
			const ctx = canvas.getContext('2d');
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			roleta(circuloBorda, numeroPalavras, anguloBase);
			
			console.log('velocidade=' + velocidade);
			
			/*
			if (anguloBaseInicial != null) {
				if (anguloBase <= anguloBaseInicial) {
					if (velocidade <= 0) {
						velocidade = 0;
					} else {
						velocidade--;
					}
				}
			}
			
			
			anguloBase = (anguloBase + velocidade) % 360;//girando
			*/
			voltas--;
			//if (anguloBase <= anguloBaseInicial) {
			if (voltas <= 0) {
				meiaFatiaDeVelocidade = 0;
				var indice = Math.floor(array.length/2);
				console.log('indice:' + indice);
				alert(array[indice]);
			}
			
			
			anguloBase = (anguloBase + meiaFatiaDeVelocidade) % 360;
			
			if (anguloBaseInicial == null) {
				anguloBaseInicial = anguloBase;
			}


		}
		
		function girarAntiHorarioHumGrau() {
			anguloBase = (anguloBase + 1) % 360;
			desenharRoleta();
		}
		
		function girarHorarioHumGrau() {
			anguloBase = anguloBase - 1;
			if (anguloBase == -1) {
				anguloBase = 359;
			}
			desenharRoleta();
		}
		
		var myInterval = null;
		
		function botarParaGirarParar() {
			var chkGirar = document.getElementById("chkGirar");
			if (chkGirar.checked) {
				myInterval = setInterval(girarVelocidade, 1);
			} else {
				clearInterval(myInterval);
			}
		}
		
		var aguardarTicks = 0;
		
		function girarVelocidade() {
			var txtVelocidade = document.getElementById("txtVelocidade");
			velocidade = txtVelocidade.value;
			
			var faixa = Math.floor(10000/limiteIntervalo);
			
			
			
			girar(Math.floor(velocidade/faixa));

		}
		
		/*
		velocidade : intervalo de 0 a 12
		*/
		
		var metadeIntervalo = 7;
		var limiteIntervalo = 15;
		
		function girar(velocidade) {
			
			console.log("girar(" + velocidade + ")");
		
			if (velocidade > 0) {
			
				if (velocidade - metadeIntervalo > 0) {
					for(var i = 0; i < velocidade - (metadeIntervalo - 1);i++) {
						girarHorarioHumGrau();
					}
				} else {
					if (aguardarTicks == 0) {
						girarHorarioHumGrau();
						aguardarTicks = metadeIntervalo - velocidade;
					} else {
						aguardarTicks--;
					}
				}
			}			
		}
		
		function telaSelecionada() {
			console.log('telaSelecionada()');
			
			
			var tela = document.querySelector('input[type = radio][name = tela]:checked').value;
			
			var painelVelocidadeConstante = document.getElementById('painelVelocidadeConstante');
			
			var painelPeteleco = document.getElementById('painelPeteleco');
			
			var chkGirar = document.getElementById('chkGirar');
			chkGirar.checked = false;
			botarParaGirarParar();
			
			console.log('telaSelecionada() => tela = ' + tela);
			
			if (tela == 1) {
				painelVelocidadeConstante.hidden = false;
				painelPeteleco.hidden = true;
			} else {
				painelVelocidadeConstante.hidden = true;
				painelPeteleco.hidden = false;		
			}
		}
		
		var forcaPeteleco = 0;
		var forcaPetelecoInicial = 0;
		var atrito = 0;
		
		function botarParaGirarParar() {
			var chkGirar = document.getElementById("chkGirar");
			if (chkGirar.checked) {
				myInterval = setInterval(girarVelocidade, 1);
			} else {
				clearInterval(myInterval);
				myInterval = null;
			}
		}
		
		function darPeteleco() {
			var txtForcaPeteleco = document.getElementById('txtForcaPeteleco');
			
			forcaPeteleco = parseInt(txtForcaPeteleco.value);
			
			forcaPetelecoInicial = forcaPeteleco;
			
			var txtAtrito = document.getElementById('txtAtrito');
			
			atrito = parseFloat(txtAtrito.value);
			
			if (forcaPeteleco > 0 && myInterval == null) {
				myInterval = setInterval(girarPorPeteleco, 1);
			} else {
				clearInterval(myInterval);
				myInterval = null;			
			}
			
		}
		
		function girarPorPeteleco() {
			velocidade = Math.ceil(forcaPeteleco/1000);
			girar(velocidade);
			
			var reducaoAtrito = Math.ceil(forcaPeteleco * atrito);
			if (reducaoAtrito == 0) {
				forcaPeteleco = 0;
			} else {
				forcaPeteleco = forcaPeteleco - reducaoAtrito;
			}
			
			var txtForcaPeteleco = document.getElementById('txtForcaPeteleco');
			txtForcaPeteleco.value = forcaPeteleco;
			
			console.log('forcaPeteleco = ' + forcaPeteleco);
			
			if (forcaPeteleco <= 0) {
				console.log('clearInterval(myInterval), forcaPeteleco');
				clearInterval(myInterval);
				myInterval = null;
				txtForcaPeteleco.value = forcaPetelecoInicial;
			}
		}
		
	</script>
	
	<body>
	
		<h1>Sorteador</h1>
		
		
		<div id="painelEntradaListaPalavras" hidden>
			<textarea cols="50" rows="20">
			</textarea>
		</div>
		
		<p>Girando...</p>
		
		<canvas id="myCanvas" width="500" height="500" border="1">
		</canvas>
		
		<div id="painelSelecaoTela">

		</div>
		
		
		
			<form id="formVelocidadeConstante">
				<label>Tipo Movimento</label>
				<br/>
				<input type="radio" name="tela" value="1" onclick="telaSelecionada()" selected />Velocidade Constante
				<br/>
				<input type="radio" name="tela" value="2" onclick="telaSelecionada()"/>Peteleco
				<br/>
			
				<div id="painelVelocidadeConstante">
					<label for="txtVelocidade">Velocidade</label>
					<br/>
					<input type="number" value="1000" id="txtVelocidade" min="0" max="10" step="1" onclick="" />
					<input type="button" value="<" onclick="girarAntiHorarioHumGrau()"/>
					<input type="button" value=">" onclick="girarHorarioHumGrau()"/>
					<br/>
					Girar: <input type="checkbox" id="chkGirar" onclick="botarParaGirarParar()"/>
				</div>
				
				<div id="painelPeteleco">
					<label for="txtForcaPeteleco">Força peteleco</label>
					<br/>
					<input type="number" value="10000" id="txtForcaPeteleco" min="0" max="10000" step="1000" onclick="" />
					<br/>
					<label for="txtAtrito">Atrito</label>
					<br/>
					<input type="number" value=".001" id="txtAtrito" min="0" max="1" step=".01" onclick="" />
					<br/>
					<input type="button" value="Peteleco!" onclick="darPeteleco()"/>
				</div>
				
				<label for="txtAnguloBase">Angulo Base</label>
				<br/>
				<input type="text" value="" id="txtAnguloBase" disabled="disabled" readonly="readonly"/>

			</form>
		
		</div>

		<script>
		
			numeroPalavras = 7;
		
			for (var palavra = 0; palavra < numeroPalavras; palavra++) {
				array[palavra] = palavra + 1;
			}
			
			//shuffle(array);
			disporNumerosNaRoleta(array);
		
			//Se numero de palavras for par, voltas deve ser ímpar
			//Se numero de palavras for ímpar, voltas deve ser par
			voltas = (360 % numeroPalavras) + 11;
			
			desenharRoleta();
		
			//setInterval(desenharRoleta, 300);
			/*
			
			6 numeros -> angulo base = 30
			
			
			var circuloBorda = {
				x: 250.0,
				y: 250.0,
				raio: 200.0
			};


			roleta(circuloBorda, 5, 90);
			*/
			/*
			borda(circuloBorda);
			
			var numeroPalavras = 25;
			
			var anguloFatiaPizza = 360.0 / numeroPalavras;
			
			console.log('anguloFatiaPizza=' + anguloFatiaPizza);
			
			var angulo = 0;
			
			
			for (var numPalavra = 0; numPalavra < numeroPalavras; numPalavra++) {

				angulo += anguloFatiaPizza;
			
				raioCirculo(circuloBorda, angulo);
				
			}
			*/

			/*
			var circuloBorda = {
				x: 400.0,
				y: 250.0,
				raio: 100.0
			};

		
			desenharFatiaSelecionada(circuloBorda, 0, 30);
			*/
			
		

		</script>

	</body>
</html>